<!DOCTYPE html>
<html>
<head>
    <title>Werewolf</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="scripts.js" defer></script>
</head>
<body x-data="setup()">
    <div class="pure-g">
        <div class="panel">
            <h1 x-text="gameTitle">Game in progress</h1>
            <div id="time-keeper">                
                <p id="hourglass" x-show="!isRingleaderDone">
                    <i class="fa-solid fa-hourglass-start" x-show="!halfwayPoint && !endPoint"></i>
                    <i class="fa-solid fa-hourglass-half" x-show="halfwayPoint && timeToDisplay > 10"></i>
                    <i class="fa-solid fa-hourglass-end fa-beat-fade" x-show="timeToDisplay && timeToDisplay <= 10"></i>
                </p>
                <p id="hourglass-ringleader" class="danger" x-show="isRingleaderDone">
                    <i class="fa-solid fa-hourglass-start" x-show="timeToDisplay >= 40"></i>
                    <i class="fa-solid fa-hourglass-half" x-show="timeToDisplay > 15 && timeToDisplay < 40"></i>                   
                    <i class="fa-solid fa-hourglass-end fa-beat-fade" x-show="timeToDisplay <= 15"></i>
                </p>
                <p id="timer" x-show="timer" x-text="timer"></p>                
            </div>
            <p x-show="isGameOver">Time's up!</p>
            <p x-text="instruction" x-show="!isRingleaderDone">You may scan a card to activate its ability.</p>
        </div>
        <div id="scan-area" class="panel clear" x-show="!isRingleaderDone">
            <div class="circle" aria-hidden="true"></div>
            <span>Place card under here.</span>
        </div>
                <!-- TESTING FEATURE: Quick links to character roles -->            
                <!-- <a class="pure-button button-small" href="scan.html?role=villager&id=8428">Villager1</a>
                <a class="pure-button button-small" href="scan.html?role=villager&id=9510">Villager2</a>
                <a class="pure-button button-small" href="scan.html?role=villager&id=7538">Villager3</a>
                <a class="pure-button button-small" href="scan.html?role=werewolf&id=5174">Werewolf1</a>
                <a class="pure-button button-small" href="scan.html?role=werewolf&id=3096">Werewolf2</a>
                <a class="pure-button button-small" href="scan.html?role=werewolf&id=7143">Werewolf3</a>
                <a class="pure-button button-small" href="scan.html?role=watcher&id=5508">Watcher</a>
                <a class="pure-button button-small" href="scan.html?role=drifter&id=9326">Drifter</a>
                <a class="pure-button button-small" href="scan.html?role=astrologer&id=3863">Astrologer</a>
                <a class="pure-button button-small" href="scan.html?role=turncloak&id=5310">Turncloak</a>
                <a class="pure-button button-small" href="scan.html?role=deviant&id=4729">Deviant</a>
                <a class="pure-button button-small" href="scan.html?role=saint&id=1240">Saint</a>
                <a class="pure-button button-small" href="scan.html?role=tracker&id=9671">Tracker</a>
                <a class="pure-button button-small" href="scan.html?role=gossip&id=5732">Gossip</a>
                <a class="pure-button button-small" href="scan.html?role=houndskeeper&id=4957">Houndskeeper</a> -->
                <!-- // TESTING FEATURE: Quick links to character roles -->   
        <div id="mayor" class="panel" x-show="isRingleaderDone && mayor">
            <h1><strong><span class="ringleader" x-text="mayor"></span></strong> was appointed ringleader!</h1>
            <p x-show="mayor != 'No one'">They will cast 2 votes.</p>            
        </div>
        
        <div class="panel clear">
            <div id="end-game-control" x-show="isRingleaderDone || isGameOver">
                <div class="progress-display">
                    <span class="progress-percent">0%</span>
                    <br>
                    <progress class="progress-bar" max="100" value="0"></progress>            
                    <br>
                </div>
                <button type="button" class="pure-button">                    
                    <i class="fa-solid fa-power-off"></i>
                    Back to lobby <small>(hold)</small>
                </button>
            </div>
            <div id="skip-game-control" x-show="!isRingleaderDone && !isGameOver && !isClient">
                <div class="progress-display">
                    <span class="progress-percent">0%</span>
                    <br>
                    <progress class="progress-bar" max="100" value="0"></progress>            
                    <br>
                </div>
                <button type="button" class="pure-button">
                    <i class="fa-solid fa-forward"></i>
                    Skip to ringleader results <small>(hold)</small>
                </button>
            </div>
        </div>        
    </div>
    <script>
        function setup() {
            return {
                players: [],
                timer: 0,
                timeToDisplay: 0,
                totalTime: 605,
                ringleaderTime: 60,
                isRingleaderDone: false,
                isGameOver: false,
                isClient: localStorage.getItem('isClient') === 'true',
                mayor: "",
                halfwayPoint: false,
                endPoint: false,
                gameTitle: "Game in progress",
                instruction: "You may scan a card to activate its ability.",
                loadPlayersFromLocalStorage() {
                    const storedPlayers = JSON.parse(localStorage.getItem('players'));
                    if (storedPlayers) {
                        this.players = storedPlayers;
                    }
                },
                getMayor() {
                    // Return the player with the most votes for mayor, ties mean no mayor

                    // Find the players with mayor votes
                    let candidates = this.players.filter(player => player.mayorVotes > 0);

                    // Find the highest number of votes
                    const maxVotes = Math.max(...candidates.map(player => player.mayorVotes));

                    // Filter the candidates to only those with the most votes
                    candidates = candidates.filter(player => player.mayorVotes === maxVotes);

                    // If there was one person with the most votes, they're the mayor
                    if (candidates.length === 1) {
                        return candidates[0].name;
                    }
                    else {
                        return 'No one';
                    }
                },

                startTimer() {                    
                    // The time elapsed is the current time minus the time the game started
                    const currentTime = new Date().getTime();
                    const gameStartTime = parseInt(localStorage.getItem('gameStartTime'));
                    const timeElapsed = currentTime - gameStartTime;

                    // The remaining time is the total time minus the time elapsed
                    remainingTime = this.totalTime - Math.floor(timeElapsed / 1000); 
                    
                    let interval = setInterval(() => {
                        if (Alpine.store("gameState").isGameSkipped && !this.isRingleaderDone) {                            
                            remainingTime = this.ringleaderTime;                             
                        }                        
                        if (remainingTime <= 0) {
                            clearInterval(interval);                            
                            this.gameOver();                        
                        } else {
                            let halfOfRegularTime = (this.totalTime - this.ringleaderTime) / 2;
                            let RegularHalfwayPoint = halfOfRegularTime + this.ringleaderTime;
                            if (remainingTime <= RegularHalfwayPoint) {
                                if (!this.halfwayPoint) {
                                    localStorage.setItem('isSecondHalf', true);
                                    this.halfwayPoint = true;
                                }        
                            }
                            else {
                                localStorage.removeItem('isSecondHalf');
                            }

                            if (remainingTime <= this.ringleaderTime && !this.isRingleaderDone) {
                                this.mayor = this.getMayor();
                                this.endPoint = true;                               
                                this.isRingleaderDone = true;                                
                            }
                            remainingTime--;

                            // Update the timer display, show the total time minus the ringleader time (if it hasn't been done yet)
                            this.timeToDisplay = remainingTime - (this.isRingleaderDone ? 0 : this.ringleaderTime);
                            this.updateTimerDisplay(this.timeToDisplay);
                        }        
                    }, 1000);
                },       
                updateTimerDisplay(remainingTime) {
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    this.timer = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                },

                gameOver() {
                    // End the game. Indicate that the game is over and show the final vote instruction.

                    this.instruction = "";
                    this.gameTitle = "Final vote";
                    this.isGameOver = true;
                    localStorage.setItem('isGameOver', "true");
                },

                init() {
                    // Set up data store for skipped game variable. Alpine.store is used because this variable is updated in a plain js function.
                    Alpine.store("gameState", {
                       isGameSkipped: false,
                    });

                    const gameName = localStorage.getItem('gameName');                    

                    if (gameName) {
                        this.gameTitle = "Welcome to " + gameName;
                    }
                    else {
                        this.gameTitle = "Game in progress";
                    }

                    this.loadPlayersFromLocalStorage();

                    const isGameOver = localStorage.getItem('isGameOver') === 'true';
                    const isGameStarted = localStorage.getItem('isGameStarted') === "true";

                    // Timer function
                    if (isGameStarted && !isGameOver) {
                        this.startTimer(); 
                    }
                    if (!isGameStarted) {                        
                        this.instruction = "You're ready. Card scanning will work once host starts the game.";
                    }
                    else if (isGameOver) {
                        this.gameTitle = "Game over";
                        this.instruction = "Time to vote if you haven't already done so.";

                        // Check if the ringleader was appointed
                        if (!this.isRingleaderDone) {
                            this.mayor = this.getMayor();
                            this.endPoint = true;                               
                            this.isRingleaderDone = true;
                        }
                    }
                }                
            }
        }   
    </script>
</body>
</html>