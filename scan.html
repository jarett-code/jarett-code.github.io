<!DOCTYPE html>
<html>
<head>
    <title>Werewolf</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="scripts.js" defer></script>    
</head>
<body x-data="setup()">
    <div class="panel">
        <h1>Scan player cards</h1>
        <p id="gameInfo">Scan the player cards to assign roles.</p>
    </div>

    <div id="specialAbility" class="special-ability" x-show="specialAbilityVisible">
        <!-- Secondary controls -->
        <div id="role-secondary-controls">
            <!-- Allow sniff left control -->
            <button class="pure-button button-secondary sniff" @click="allowSniff(direction='left')" :class="{ 'active': isSniffLeftAllowed }" x-show="showSniffButtons" :disabled="lockSniffLeft" x-transition.opacity.100.duration.2000ms>
                <i class="fa-solid fa-arrow-left"></i>
                Allow sniff
            </button>
            <!-- Role help control -->
            <button class="pure-button button-secondary" @click="showRoleHelp = !showRoleHelp" :class="{ 'active': showRoleHelp }">
                <i class="fa-solid fa-question"></i>
                Help
            </button>
            <!-- Allow sniff right control -->
            <button class="pure-button button-secondary sniff" @click="allowSniff(direction='right')" :class="{ 'active': isSniffRightAllowed }" x-show="showSniffButtons" :disabled="lockSniffRight" x-transition.opacity.100.duration.2000ms>
                Allow sniff
                <i class="fa-solid fa-arrow-right"></i>
            </button>            
            <!-- Role help description -->
            <div id="role-help" x-show="showRoleHelp">
                <p x-text="roleHelp[role]"></p>
                <p x-show="isHoundskeeperInGame" class="houndskeeper-help">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    Werewolf and Houndskeeper players may sniff out the role of the players beside them. However, the players to be sniffed must first allow it by using the controls above.
                </p>
            </div>
        </div>        

        <p id="abilityMessage" x-text="abilityMessage"></p>
        <!-- Gossip messages -->
        <p id="gossip1" x-text="gossip1" x-show="gossip1"></p>
        <p id="gossip2" x-text="gossip2" x-show="gossip2"></p>
        <div id="ability-effect"></div>
        <!-- The main ability button -->
        <button id="useAbilityButton" x-show="showMainAbilityButton" class="pure-button" @click="activateRole()" x-transition.opacity.scale.30.duration.1500ms :disabled="getCurrentPlayer().usedAbility">
            <i class="fa-solid fa-hands-holding-circle"></i>
            <!-- <i class="fa-solid fa-eye"></i> -->
        </button>
        <!-- Villager controls -->
        <div id="villagerControls" x-show="showVillagerControls" x-transition.opacity.0.duration.1500ms>
            <select class="playerSelect" x-model="selectedPlayer" @change="villagerAbility()">
                <option value="">Select a player</option>
                <template x-for="player in playersToVote" :key="player.name">
                    <option x-text="player.name" :value="player.id"></option>
                </template>
            </select>
            <br>
        </div>
        <!-- Tracker controls -->
        <button id="trackLeftButton" x-show="showTrackerButtons" class="trackerButton pure-button button-primary" @click="trackerAbility(trackDirection='left')">
            <i class="fa-solid fa-arrow-left"></i>
            Track left
        </button>
        <button id="trackRightButton" x-show="showTrackerButtons" class="trackerButton pure-button button-primary" @click="trackerAbility(trackDirection='right')">
            Track right
            <i class="fa-solid fa-arrow-right"></i>
        </button>      
        <!-- Watcher controls -->
        <div id="watcherControls" x-show="showWatcherControls" x-transition.opacity.0.duration.1500ms>
            <select class="playerSelect" x-model="selectedPlayer" @change="watcherAbility()">
                <option value="">Select a player</option>
                <template x-for="player in playersToView" :key="player.name">
                    <option x-text="player.name" :value="player.name"></option>
                </template>
            </select>
            <br>
        </div>
        <!-- Button which navigates the user back to the gameplay.html page -->
        <button id="cancel-ability" onclick="window.location.href='gameplay.html'" class="pure-button button-primary">
            <i class="fa-solid fa-arrow-left"></i>
            Go back
        </button>        
    </div>

    <script>
        function setup() {
            return {
                roles: ["werewolf", "villager", "watcher", "tracker", "deviant", "saint", "gossip", "turncloak", "astrologer", "drifter", "houndskeeper"],
                roleHelp: {
                    "werewolf": "You are a Werewolf. Survive and ensure a member of the townfolk dies. You can also win if all Werewolves vote for the Saint.",
                    "villager": "You are a Villager. Help the town eliminate a Werewolf. Villagers may agree to appoint a ringleader, giving that player an extra vote at the end.",
                    "watcher": "You are the Watcher. You can view another player to gain a clue about their role.",
                    "tracker": "You are the Tracker. You can choose which half of the players at the table to track; this will determine if a Werewolf is among them.",
                    "deviant": "You are the Deviant. Your only goal is to trick the town into killing you.",
                    "saint": "You are the Saint. Don't let the Werewolves discover your role. Discreetly guide the townsfolk to victory.",
                    "gossip": "You are the Gossip. You get 2 clues, the 2nd is available halfway through the game. One clue may be false.",
                    "turncloak": "You are the Turncloak. You serve the Werewolves and must help them win â€” even if you must die.",
                    "astrologer": "You are the Astrologer. You can determine one role that is definitely in play.",
                    "drifter": "You are the Drifter. You can determine 2 roles not in play. In other words, you identify 2 of the non-player cards from the centre.",
                    "houndskeeper": "You are the Houndskeeper. You may sniff out the role of either player next to you...if they first allow it."
                },
                players: [],
                extraRoles:[],
                playersToView: [],
                playersToVote: [],
                abilityMessage: '',
                gossip1: null,
                gossip2: null,
                holdTimeout: null,                
                specialAbilityVisible: false,
                showMainAbilityButton: true,
                showWatcherControls: false,
                showVillagerControls: false,
                showTrackerButtons: false,
                showRoleHelp: false,
                showSniffButtons: false,                
                isSniffLeftAllowed: false,
                isSniffRightAllowed: false,
                lockSniffLeft: false,
                lockSniffRight: false,
                audio: new Audio('sounds/power_activated.mp3'),
                role: null,
                id: null,
                selectedPlayer: null,

                getRole() {
                    const params = new URLSearchParams(window.location.search);
                    // The role must exist in the roles array
                    if (!this.roles.includes(params.get('role'))) {
                        alert('Invalid role scanned');
                    }
                    else {
                        this.role = params.get('role');
                        this.id = params.get('id');
                    }
                    return this.role;
                },

                getCurrentPlayer() {
                    // Using the id parameter, get the current player  
                    const params = new URLSearchParams(window.location.search);
                    const id = params.get('id');

                    return this.players.find(player => player.id === id);
                },

                loadPlayersFromLocalStorage() {
                    const storedPlayers = JSON.parse(localStorage.getItem('players'));
                    if (storedPlayers) {
                        this.players = storedPlayers;
                    }
                },

                loadExtraRolesFromLocalStorage() {
                    const storedExtraRoles = JSON.parse(localStorage.getItem('extraRoles'));
                    if (storedExtraRoles) {
                        this.extraRoles = storedExtraRoles;
                    }
                },

                allowSniff(direction) {
                    // Allow a werewolf or houndskeeper from the selected direction to sniff the role of the current player

                    const currentPlayer = this.getCurrentPlayer();
                    const adjacentPlayer = this.getAdjacentPlayer(direction);
                    let sniffText = '';

                    if (direction === 'left') {
                        // Toggle the sniff attribute                        
                        if (currentPlayer.allowSniffLeft !== "yes") {                            
                            currentPlayer.allowSniffLeft = "yes";
                            this.isSniffLeftAllowed = true;
                            sniffText = `${adjacentPlayer.name} can now sniff you (if they are a Houndskeeper or Werewolf).`;                            
                        }
                        else {
                            currentPlayer.allowSniffLeft = "no";
                            this.isSniffLeftAllowed = false;
                            sniffText = `${adjacentPlayer.name} can no longer sniff you.`;
                        }                       
                    }
                    else if (direction === 'right') {
                        // Toggle the sniff attribute
                        if (currentPlayer.allowSniffRight !== "yes") {
                            currentPlayer.allowSniffRight = "yes";
                            this.isSniffRightAllowed = true;
                            sniffText = `${adjacentPlayer.name} can now sniff you (if they are a Werewolf or Houndskeeper).`;
                        }
                        else {
                            currentPlayer.allowSniffRight = "no";
                            this.isSniffRightAllowed = false;
                            sniffText = `${adjacentPlayer.name} can no longer sniff you.`;
                        }
                    }
                    
                    // Delete any existing sniff message elements
                    const existingSniffMessage = document.querySelector('p.sniff-message');
                    if (existingSniffMessage) {
                        existingSniffMessage.remove();
                    }

                    // Add a new message element to the DOM
                    sniffMessageElement = document.createElement('p');
                    sniffMessageElement.textContent = sniffText;
                    sniffMessageElement.classList.add('sniff-message');
                    sniffMessageElement.setAttribute('x-data', '{ sniffTextToggle: true }');
                    sniffMessageElement.setAttribute('x-show', 'sniffTextToggle; setTimeout(() => { sniffTextToggle = false; }, 4000);');
                    sniffMessageElement.setAttribute('x-transition:leave.duration.2000ms', '');
                    document.getElementById('role-secondary-controls').appendChild(sniffMessageElement);                   

                    this.savePlayersToLocalStorage();
                },

                assignRole(role) {
                    // Get the next unassigned player and assign the role
                    for (let player of this.players) {
                        if (!player.role) {
                            player.role = role;
                            player.id = this.id;
                            break;
                        }
                    }
                    this.savePlayersToLocalStorage();                   
                },

                assignExtraRole() {                    
                    // Push the role to the extraRoles array and save it to local storage
                    this.extraRoles.push(this.getRole());
                    localStorage.setItem('extraRoles', JSON.stringify(this.extraRoles));
                },

                savePlayersToLocalStorage() {
                    localStorage.setItem('players', JSON.stringify(this.players));
                },

                allRolesAreAssigned() {
                    return this.players.every(player => player.role);
                },

                startTheGame() {                    
                    // Prepare the game and display a 3-second countdown

                    localStorage.removeItem('isScanStarted');
                    localStorage.setItem('isGameStarted', true);
                    localStorage.removeItem('remainingTime');

                    let count = 3;
                    const countdown = setInterval(() => {
                        if (count > 0) {
                            document.getElementById('gameInfo').textContent = `Game starting in...${count}`;
                            count--;
                        } else {
                            clearInterval(countdown);
                            window.location.href = 'gameplay.html';
                        }
                    }, 1000);
                  
                },

                isHoundskeeperInGame() {
                    // Return whether the Houndskeeper is in the game
                    
                     // Get all the players, plus extra roles
                    const allRoles = this.players.map(player => player.role).concat(this.extraRoles);
                        
                    if (allRoles.includes('houndskeeper'))
                        return true;
                    else
                        return false;
                },

                init() {
                    this.loadPlayersFromLocalStorage();
                    this.loadExtraRolesFromLocalStorage();
                    this.getRole();
                    this.isHoundskeeperInGame = this.isHoundskeeperInGame();
                    this.initializeSniffButtons();

                    // Temporarily reset the usedAbility flag for all players TESTING!!!!!!!!!!!!!!!!!!!!!!!
                    this.players = this.players.map(player => ({ ...player, usedAbility: false }));
                    // Temporarily reset the usedAbility flag for all players TESTING!!!!!!!!!!!!!!!!!!!!!!!

                    // If the game has started, the scan activates the special ability screen.
                    if (localStorage.getItem('isGameStarted')) {
                        this.specialAbilityVisible = true;
                    }

                    // Assign roles only if the game has not started.
                    if (localStorage.getItem('isScanStarted') && !localStorage.getItem('isGameStarted')) {
                        
                        // If all player roles have been assigned, scan the extra roles.
                        if (this.allRolesAreAssigned()) {
                            this.assignExtraRole();
                        }
                        else {
                            this.assignRole(this.getRole());
                        }

                        // If all necessary cards have been scanned, start the game
                        if (this.allRolesAreAssigned() && this.extraRoles.length === 3) {                         
                            this.startTheGame();
                        }
                        else {
                            window.location.href = 'next_player_to_scan.html';
                        }
                    }
                },

                initializeSniffButtons() {
                        // Only display these controls if the houndskeeper is in the game.
                        // Displays buttons in style according to saved state. Adds a delay to protect the player's privacy.
                        
                        if (this.isHoundskeeperInGame) {
                            const currentPlayer = this.getCurrentPlayer();                            

                            // Add a 2 second delay before the sniff button statuses are displayed
                            this.holdTimeout = setTimeout(() => {
                                this.isSniffLeftAllowed = currentPlayer.allowSniffLeft === "yes";
                                this.isSniffRightAllowed = currentPlayer.allowSniffRight === "yes";                                

                                // Lock the allow sniff buttons if the player has already sniffed the adjacent players themselves.
                                if (currentPlayer.allowSniffLeftPermanent === "yes")
                                    this.lockSniffLeft = true;

                                if (currentPlayer.allowSniffRightPermanent === "yes")
                                    this.lockSniffRight = true;                                

                                this.showSniffButtons = true;
                            }, 2000);
                        } 
                },

                activateRole() {
                    // Depending on the role, the player can activate a special ability.
                    // Some roles require additional controls to perform their ability.
                    const role = this.getRole();
                    const currentPlayer = this.getCurrentPlayer();
                    const specialAbilityDiv = document.getElementById('specialAbility');
                    const abilityMessage = document.getElementById('abilityMessage');

                    // Hide the main special ability button
                    this.showMainAbilityButton = false;

                    if (currentPlayer.usedAbility) {
                        abilityMessage.textContent = 'You have already used your ability';
                        return;
                    }                    
                    
                    if (role === 'tracker') {                                                
                        // If the role is tracker, display the tracking buttons and hide the main special ability button
                        this.showTrackerButtons = true;
                    }else if (role === 'watcher') {
                        // If the role is watcher, display the watcher controls
                        this.showWatcherControls = true;
                        this.playersToView = this.players.filter(player => player.role && player.role !== 'watcher');                                        
                    } else if (role === 'villager') {
                        // If the role is villager, display the villager controls for voting
                        this.showVillagerControls = true;
                        this.playersToVote = this.players.filter(player => player.role && player.id !== currentPlayer.id);
                    } else if (role === 'werewolf' && this.isHoundskeeperInGame) {
                        // If the role is werewolf or houndskeeper, activate the sniff ability
                        this.sniffAbility();
                    } else if (role === 'houndskeeper') {
                        this.sniffAbility();
                    } else if (role === 'saint') {
                        this.saintAbility();                 
                    } else if (role === 'astrologer') {
                        this.astrologerAbility();
                    } else if (role === 'turncloak') {
                        this.turncloakAbility();
                    } else if (role === 'drifter') {
                        this.drifterAbility();
                    } else if (role === 'gossip') {
                        // For the gossip, the ability is performed once, and the results are saved for later
                        // So if the the gossip clues have already been created, just display them and don't execute the ability again
                        // Display the first gossip message during the first half of the game and both during the second half                       
                        
                        if (localStorage.getItem('firstGossip') && localStorage.getItem('secondGossip')) {                            
                            this.gossip1 = localStorage.getItem('firstGossip');
                            if (localStorage.getItem('isSecondHalf')) {                               
                                this.gossip2 = localStorage.getItem('secondGossip');
                            }
                        } else {
                            this.gossipAbility();
                        }                      
                    } else {                       
                        bluffingMessages = [
                            "Keep a straight face", 
                            "How will you get out of this one?",
                            "You're bluffing, right?",
                            "In for a penny, in for a pound",
                            "You're in deep now",
                            "Do you think they're buying it?",
                            "Do you sell used cars?",
                            "The elder gods frown on your deceit",
                            "Is this your plan?",
                            "You're not fooling anyone",
                            "Do you have a poker face?",
                            "Do you think you're clever?",
                            "Do you kiss your mother with those lying lips?",
                            "It's not a lie if you believe it",
                            "The bigger the lie, the more they'll believe it",
                            "You're a regular Pinocchio",
                            "You...may be a werewolf",
                            "All is fair in love and werewolves",
                        ];
                        abilityMessage.textContent = bluffingMessages[Math.floor(Math.random() * bluffingMessages.length)];

                        // Activate special effects
                        this.specialEffects();
                    }               
                },
                villagerAbility() {
                    // Villagers can appoint a mayor (ringleader), who casts two votes

                    // Add a vote to the tally of whoever the player chose
                    const selectedPlayer = this.players.find(player => player.id === this.selectedPlayer);
                    selectedPlayer.mayorVotes++;

                    // Remove the dropdown after the ability is used
                    this.showVillagerControls = false;

                    abilityMessage.textContent = `You have voted ${selectedPlayer.name} for ringleader`;

                    // Activate special effects
                    this.specialEffects();

                    // Mark the player as having used their ability
                    this.getCurrentPlayer().usedAbility = true;
                    this.savePlayersToLocalStorage();

               },
                saintAbility() {
                    // The saint learns the identity of a werewolf
                    const werewolfPlayers = this.players.filter(player => player.role === 'werewolf');
                    const randomWerewolf = werewolfPlayers[Math.floor(Math.random() * werewolfPlayers.length)];
                    abilityMessage.textContent = randomWerewolf ? `${randomWerewolf.name} is a werewolf` : 'No werewolf found';

                    this.specialEffects();  
                    
                    // Mark the player as having used their ability
                    this.getCurrentPlayer().usedAbility = true;
                    this.savePlayersToLocalStorage();
                },

                astrologerAbility() {
                    // The astrologer learns if any special roles are present

                     // Get all the special roles in this game except werewolf, villager, and astrologer
                     const possibleRoles = this.players
                            .filter(player => player.role && player.role !== 'werewolf' && player.role !== 'villager' && player.role !== 'astrologer')
                            .map(player => player.role);                    

                    // Now, pick a random role from the possible roles
                    const randomRole = possibleRoles[Math.floor(Math.random() * possibleRoles.length)];
                    abilityMessage.textContent = randomRole ? `The ${randomRole} is present` : 'No special roles found';

                    this.specialEffects();

                    // Mark the player as having used their ability
                    this.getCurrentPlayer().usedAbility = true;
                    this.savePlayersToLocalStorage();
                },

                drifterAbility() {
                    // The drifter discovers 2 roles that are not in play
                    
                    // Pick two random roles from the 3 extras
                    const drifterResult = this.extraRoles.sort(() => 0.5 - Math.random()).slice(0, 2);
                    
                    let prefix = "";
                    let clue = "";

                    drifterResultRolesAreSame = drifterResult[0] == drifterResult[1];

                    // If the results contain the same role, change up the wording
                    if (drifterResultRolesAreSame) {
                        if (drifterResult[0] == "werewolf")
                            clue = "Two less werewolves";
                        else if (drifterResult[0] == "villager")
                            clue = "Two less villagers";
                    }
                    else {
                        for (drifterResultRole of drifterResult) {
                            if (drifterResultRole == "werewolf" || drifterResultRole == "villager")
                                prefix = "One less ";                                            
                            else
                                prefix = "No ";

                            clue += prefix + drifterResultRole + ". ";
                        }
                    }

                    abilityMessage.textContent = clue;

                    this.specialEffects();

                    // Mark the player as having used their ability
                    this.getCurrentPlayer().usedAbility = true;
                    this.savePlayersToLocalStorage();
                },

                turncloakAbility() {
                    // The turncloak learns the identity of the werewolves
                    const werewolfPlayers = this.players.filter(player => player.role === 'werewolf');
                    const werewolfNames = werewolfPlayers.map(player => player.name).join(' and ');

                    if (werewolfPlayers.length === 0) {
                        abilityMessage.textContent = 'No werewolves';
                    } else if (werewolfPlayers.length === 1) {
                        abilityMessage.textContent = `Your werewolf is ${werewolfNames}`;
                    }
                    else {
                        abilityMessage.textContent = `Your werewolves are ${werewolfNames}`;
                    }

                    this.specialEffects();
                },

                gossipAbility() {
                    // The gossip learns something about 2 random players. One is true, the other is true or false.

                    // Get all players except the gossip, and shuffle them
                    const players = this.players.filter(player => player.role !== 'gossip');
                    let randomPlayers = players.sort(() => 0.5 - Math.random());                   

                    // Pop off two random players
                    trueRole = randomPlayers.pop();
                    maybeRole = randomPlayers.pop();

                    // Prepare the true gossip by picking out the first random player.
                    trueGossip = `${trueRole.name} may be ${useAorAn(trueRole.role)} ${trueRole.role}`;

                    // Prepare the potentially false gossip -- 50% chance
                    const isTrueGossip = Math.random() < 0.5;

                    if (isTrueGossip) {                       
                        maybeGossip = `${maybeRole.name} may be ${useAorAn(maybeRole.role)} ${maybeRole.role}`;
                    } else {
                        const randomRole = randomPlayers.pop().role;
                        maybeGossip = `${maybeRole.name} may be ${useAorAn(randomRole)} ${randomRole}`;
                    }

                    // Now that we have our 2 gossips, choose a random order to display them
                    const gossips = [trueGossip, maybeGossip];
                    const randomGossipOrder = gossips.sort(() => 0.5 - Math.random());

                    this.gossip1 = randomGossipOrder[0];

                    // Only display the second gossip if it's halfway through the game, otherwise save it for later
                    if (localStorage.getItem('isSecondHalf')) {                        
                        this.gossip2 = randomGossipOrder[1];
                    }

                    // Save both gossips for later since the gossip can use their ability more that once.
                    localStorage.setItem('firstGossip', randomGossipOrder[0]);
                    localStorage.setItem('secondGossip', randomGossipOrder[1]);
                    
                    this.specialEffects();
                },

                watcherAbility() {
                    // The watcher can view the role of another player. They'll get a true and false clue.
                    const selectedPlayer = this.players.find(player => player.name === this.selectedPlayer);
                    const abilityMessage = document.getElementById('abilityMessage');

                    // Get all roles except the watcher and the selected player
                    let playerRoles = this.players
                        .filter(player => player.role && player.role !== 'watcher' && player.role !== selectedPlayer.role)
                        .map(player => player.role);
                    let allRoles = playerRoles.concat(this.extraRoles);

                    // Shuffle the roles and grab one to use as the false role clue
                    allRoles = allRoles.sort(() => 0.5 - Math.random());
                    const falseRole = allRoles.pop();

                    // Shuffle the false role with the player's real role
                    const roleClues = [selectedPlayer.role, falseRole].sort(() => 0.5 - Math.random());

                    if (selectedPlayer) {
                        abilityMessage.textContent = 
                            `${selectedPlayer.name} is either ${useAorAn(roleClues[0])} ${roleClues[0]} 
                                or ${useAorAn(roleClues[1])} ${roleClues[1]}`;
                    } else {
                        abilityMessage.textContent = 'Player not found';
                    }
                    // Remove the dropdown after the ability is used
                    this.showWatcherControls = false;

                    // Activate special effects
                    this.specialEffects();

                    // Mark the player as having used their ability
                    this.getCurrentPlayer().usedAbility = true;
                    this.savePlayersToLocalStorage();
                },

                trackerAbility(trackDirection) {
                    // The tracker chooses which half of the players at the table track; this determines if a wolf is among them.

                    // Get the total player count
                    const totalPlayers = this.players.length;
                    // Get the position of the current player
                    const currentPlayerIndex = this.players.findIndex(player => player.role === 'tracker');
                    const numberToBeTracked = Math.floor(totalPlayers / 2);
                    let playersToTrack = [];

                    if (trackDirection == 'left') {
                        // for loop for the number to be tracked
                        for (let i = 1; i <= numberToBeTracked; i++) {
                            let playerToTrackIndex = currentPlayerIndex + i;
                            if (playerToTrackIndex > totalPlayers-1) {
                                playerToTrackIndex = playerToTrackIndex - totalPlayers;
                            }
                            playersToTrack.push(this.players[playerToTrackIndex]);
                        }
                    }
                    else if (trackDirection == 'right') {
                        // for loop for the number to be tracked
                        for (let i = 1; i <= numberToBeTracked; i++) {
                            let playerToTrackIndex = currentPlayerIndex - i;
                            if (playerToTrackIndex < 0) {
                                playerToTrackIndex = totalPlayers + playerToTrackIndex;
                            }
                            playersToTrack.push(this.players[playerToTrackIndex]);
                        }
                    }
                    if (playersToTrack.length === 2) {
                        trackedPlayerNamesString = playersToTrack.map(player => player.name).join(', ');
                    }
                    else {
                        trackedPlayerNamesString = playersToTrack.map(player => player.name).join(' and ');
                    }                    
                    const werewolfWasFound = playersToTrack.find(player => player.role === 'werewolf');
                    abilityMessage.textContent = werewolfWasFound ? `A werewolf hides amongst ${trackedPlayerNamesString}` : `No werewolves amongst ${trackedPlayerNamesString}`;

                    // Activate special effects
                    this.specialEffects();

                    // Mark the player as having used their ability
                    this.getCurrentPlayer().usedAbility = true;
                    this.savePlayersToLocalStorage();
                },

                getAdjacentPlayer(direction) {
                    // Get the adjacent player to the current player, given the direction (left or right)

                    const currentPlayer = this.getCurrentPlayer();                    
                    const currentPlayerIndex = this.players.findIndex(player => player.id === currentPlayer.id);                 
                    let nextPlayerIndex = 0;

                    if (direction === "left") {
                        nextPlayerIndex = currentPlayerIndex + 1;
                        if (nextPlayerIndex > this.players.length - 1) {
                            nextPlayerIndex = 0;
                        }
                    } else if (direction === "right") {
                        nextPlayerIndex = currentPlayerIndex - 1;
                        if (nextPlayerIndex < 0) {
                            nextPlayerIndex = this.players.length - 1;
                        }
                    }
                    return this.players[nextPlayerIndex];
                },

                sniffAbility() {
                    // A werewolf or houndskeeper can sniff out the role of either player next to them
                    const currentPlayer = this.getCurrentPlayer();
                    const abilityMessage = document.getElementById('abilityMessage');
                    let playerToSniffIndex = null;

                    // Get the index of the current player
                    const currentPlayerIndex = this.players.findIndex(player => player.id === currentPlayer.id);                    

                    // Get the two adjacent players                   
                    const playerToLeft = this.getAdjacentPlayer("left");
                    const playerToRight = this.getAdjacentPlayer("right"); 
                
                    // Show the roles of the players who consented to be sniffed
                    if (playerToLeft.allowSniffRight === "yes") {                        
                        abilityMessage.textContent = `${playerToLeft.name} is ${useAorAn(playerToLeft.role)} ${playerToLeft.role}`;                        

                        // Permanently allow sniffing in return. It's only fair.
                        currentPlayer.allowSniffLeft = "yes";
                        currentPlayer.allowSniffLeftPermanent = "yes";
                        this.isSniffLeftAllowed = true;
                        this.lockSniffLeft = true;
                    }
                    if (playerToLeft.allowSniffRight === "yes" && playerToRight.allowSniffLeft === "yes") {                        
                        abilityMessage.textContent += " & ";
                    }
                    if (playerToRight.allowSniffLeft === "yes") {                        
                        abilityMessage.textContent += `${playerToRight.name} is ${useAorAn(playerToRight.role)} ${playerToRight.role}`;

                        // Permanently allow sniffing in return. It's only fair.
                        currentPlayer.allowSniffRight = "yes";
                        currentPlayer.allowSniffRightPermanent = "yes";
                        this.isSniffRightAllowed = true;
                        this.lockSniffRight = true;
                    }
                    if (playerToLeft.allowSniffRight !== "yes" && playerToRight.allowSniffLeft !== "yes") {
                        abilityMessage.textContent += "No one wants to be sniffed";
                    }

                    this.savePlayersToLocalStorage();

                    this.specialEffects();
                },

                specialEffects() {
                    // Play the sound effect            
                    this.audio.play();

                    // Animation for main controls
                    const useAbilityButton = document.getElementById('useAbilityButton');
                    useAbilityButton.classList.add('fade-out');
                    useAbilityButton.addEventListener('transitionend', () => {
                        useAbilityButton.style.display = 'none';
                    }, { once: true });            

                    // Animation for tracker controls
                    if (this.role === "tracker") {
                        // Hide the track buttons after the ability is used
                        document.getElementById('trackLeftButton').classList.add('slide-right-fade-out');
                        document.getElementById('trackRightButton').classList.add('slide-left-fade-out');
                    }

                    // Animation for the background effect
                    const abilityEffect = document.getElementById('ability-effect');
                    abilityEffect.classList.add('growing');

                    // Animation for the special ability message
                    const abilityMessage = document.getElementById('abilityMessage');                    
                    abilityMessage.style.display = 'block';
                }
            }
        }
    </script>
</body>
</html>