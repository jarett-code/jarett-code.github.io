<!DOCTYPE html>
<html>
<head>
    <title>Werewolf</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css" integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="scripts.js" defer></script>
</head>
<body x-data="setup()">
    <div class="panel">
        <h1>Scan player cards</h1>
        <p id="gameInfo">Scan the player cards to assign roles.</p>
    </div>

    <div id="specialAbility" class="special-ability" x-show="specialAbilityVisible">        
        <p id="abilityMessage" x-text="abilityMessage"></p>
        <div id="ability-effect"></div>
        <!-- The main ability button -->
        <button id="useAbilityButton" x-show="showMainAbilityButton" class="pure-button" @click="activateRole()" x-transition.opacity.scale.30.duration.1500ms>
            <i class="fa-solid fa-hands-holding-circle"></i>
            <!-- <i class="fa-solid fa-eye"></i> -->
        </button>
        <!-- Tracker controls -->
        <button id="trackLeftButton" x-show="showTrackerButtons" class="trackerButton pure-button button-primary" @click="trackerAbility(trackDirection='left')">
            <i class="fa-solid fa-arrow-left"></i>
            Track left
        </button>
        <button id="trackRightButton" x-show="showTrackerButtons" class="trackerButton pure-button button-primary" @click="trackerAbility(trackDirection='right')">
            Track right
            <i class="fa-solid fa-arrow-right"></i>
        </button>
        <!-- Seer controls -->
        <div id="seerControls" x-show="showSeerControls" x-transition.opacity.0.duration.1500ms>
            <select id="playerSelect" x-model="selectedPlayer" @change="seerAbility()">
                <option value="">Select a player</option>
                <template x-for="player in playersToView" :key="player.name">
                    <option x-text="player.name" :value="player.name"></option>
                </template>
            </select>
            <br>
        </div>
        <!-- Button which navigates the user back to the gameplay.html page -->
        <button id="cancel-ability" onclick="window.location.href = 'gameplay.html'" class="pure-button button-primary">
            <i class="fa-solid fa-arrow-left"></i>
            Go back
        </button>
    </div>

    <script>
        function setup() {
            return {
                roles: ["werewolf", "villager", "seer", "tracker", "saint", "gossip", "minion", "astrologer", "drifter"],
                players: [],
                playersToView: [],
                abilityMessage: '',
                holdTimeout: null,                
                specialAbilityVisible: false,
                showMainAbilityButton: true,
                showSeerControls: false,
                showTrackerButtons: false,
                audio: new Audio('sounds/power_activated.mp3'),
                role: null,
                selectedPlayer: null,

                getRole() {
                    const params = new URLSearchParams(window.location.search);
                    this.role = params.get('role');                    
                    return this.role;
                },

                getCurrentPlayer() {                    
                    return this.players.find(player => player.role === this.getRole()); // TODO might break with roles assigned to 2 or more players
                },

                loadPlayersFromLocalStorage() {
                    const storedPlayers = JSON.parse(localStorage.getItem('players'));
                    if (storedPlayers) {
                        this.players = storedPlayers;
                    }
                },

                assignRole(role) {
                    // Get the next unassigned player and assign the role
                    for (let player of this.players) {
                        if (!player.role) {
                            player.role = role;
                            break;
                        }
                    }
                    this.savePlayersToLocalStorage();                   
                },          

                savePlayersToLocalStorage() {
                    localStorage.setItem('players', JSON.stringify(this.players));
                },

                allRolesAreAssigned() {
                    return this.players.every(player => player.role);
                },

                startTheGame() {                    
                    // Display a 3-second countdown to let the user know the game is ready to start
                    let count = 3;
                    const countdown = setInterval(() => {
                        if (count > 0) {
                            document.getElementById('gameInfo').textContent = `Game starting in...${count}`;
                            count--;
                        } else {
                            clearInterval(countdown);
                            window.location.href = 'gameplay.html';
                        }
                    }, 1000);
                  
                },             

                init() {
                    this.loadPlayersFromLocalStorage();
                    const role = this.getRole();

                    // Temporarily reset the usedAbility flag for all players TESTING!!!!!!!!!!!!!!!!!!!!!!!
                    this.players = this.players.map(player => ({ ...player, usedAbility: false }));

                    let isGameStarted = localStorage.getItem('isGameStarted');

                    // Assign roles only if the game has not started.
                    if (localStorage.getItem('isScanStarted') && !localStorage.getItem('isGameStarted')) {               

                        // Check if roles still need to be assigned
                        if (!this.allRolesAreAssigned()) {
                            // The role must exist in the roles array
                            if (this.roles.includes(role)) {
                                this.assignRole(role);
                            }
                        }

                        // If all roles have now been assigned, start the game -- otherwise go to the next player to scan
                        if (this.allRolesAreAssigned()) {
                            localStorage.removeItem('isScanStarted');                          
                            this.startTheGame();
                        }
                        else {
                            window.location.href = 'next_player_to_scan.html';
                        }
                       
                    }
                        
                    // If the game has started, the scan activates the special ability screen.
                    if (localStorage.getItem('isGameStarted')) {                    
                        this.specialAbilityVisible = true;
                    }
                },

                activateRole() {
                    // Depending on the role, the player can activate a special ability.
                    // Some roles require additional controls to perform their ability.
                    const role = this.getRole();
                    const currentPlayer = this.getCurrentPlayer();
                    const specialAbilityDiv = document.getElementById('specialAbility');
                    const abilityMessage = document.getElementById('abilityMessage');

                    // Hide the main special ability button
                    this.showMainAbilityButton = false;

                    if (currentPlayer.usedAbility) {
                        abilityMessage.textContent = 'You have already used your ability';
                        return;
                    }

                    // If the role is tracker, display the tracking buttons and hide the main special ability button
                    if (role === 'tracker') {                                                
                        this.showTrackerButtons = true;
                        return;
                    }
                    // If the role is seer, display the seer controls
                    if (role === 'seer') {
                        this.showSeerControls = true;
                        this.playersToView = this.players.filter(player => player.role && player.role !== 'seer');
                        return;
                    }                    
                    if (role === 'saint') {
                        this.saintAbility();                    
                    } else if (role === 'astrologer') {
                        this.astrologerAbility();
                    } else {
                        abilityMessage.textContent = "You're bluffing, right?";
                    }

                    // Activate special effects
                    this.specialEffects(role);
                    
                    // Set a flag to indicate that the player has used their ability
                    currentPlayer.usedAbility = true;
                    this.savePlayersToLocalStorage();                    
                },

                saintAbility() {
                    // The saint learns the identity of a werewolf
                    const werewolfPlayers = this.players.filter(player => player.role === 'werewolf');
                    const randomWerewolf = werewolfPlayers[Math.floor(Math.random() * werewolfPlayers.length)];
                    abilityMessage.textContent = randomWerewolf ? `${randomWerewolf.name} is a werewolf` : 'No werewolf found';
                },

                astrologerAbility() {
                    // The astrologer learns if any special roles are present

                     // Get all the special roles in this game except werewolf, villager, and astrologer
                     const possibleRoles = this.players
                            .filter(player => player.role && player.role !== 'werewolf' && player.role !== 'villager' && player.role !== 'astrologer')
                            .map(player => player.role);
                    // Now, pick a random role from the possible roles
                    const randomRole = possibleRoles[Math.floor(Math.random() * possibleRoles.length)];
                    abilityMessage.textContent = randomRole ? `The ${randomRole} is present` : 'No special roles found';
                },

                seerAbility() {
                    // The seer can view the role of another seleplayer
                    const selectedPlayer = this.players.find(player => player.name === this.selectedPlayer);
                    const abilityMessage = document.getElementById('abilityMessage');
                    if (selectedPlayer) {
                        abilityMessage.textContent = `${selectedPlayer.name} is a ${selectedPlayer.role}`;
                    } else {
                        abilityMessage.textContent = 'Player not found';
                    }
                    // Remove the dropdown after the ability is used
                    this.showSeerControls = false;

                    // Activate special effects
                    this.specialEffects();
                },

                trackerAbility(trackDirection) {
                    // The tracker chooses which half of the players at the table track; this determines if a wolf is among them.

                    // Get the total player count
                    const totalPlayers = this.players.length;
                    // Get the position of the current player
                    const currentPlayerIndex = this.players.findIndex(player => player.role === 'tracker');
                    const numberToBeTracked = Math.floor(totalPlayers / 2);
                    let playersToTrack = [];

                    if (trackDirection == 'left') {
                        // for loop for the number to be tracked
                        for (let i = 1; i <= numberToBeTracked; i++) {
                            let playerToTrackIndex = currentPlayerIndex + i;
                            if (playerToTrackIndex > totalPlayers-1) {
                                playerToTrackIndex = playerToTrackIndex - totalPlayers;
                            }
                            playersToTrack.push(this.players[playerToTrackIndex]);
                        }
                    }
                    else if (trackDirection == 'right') {
                        // for loop for the number to be tracked
                        for (let i = 1; i <= numberToBeTracked; i++) {
                            let playerToTrackIndex = currentPlayerIndex - i;
                            if (playerToTrackIndex < 0) {
                                playerToTrackIndex = totalPlayers + playerToTrackIndex;
                            }
                            playersToTrack.push(this.players[playerToTrackIndex]);
                        }
                    }
                    if (playersToTrack.length === 2) {
                        trackedPlayerNamesString = playersToTrack.map(player => player.name).join(', ');
                    }
                    else {
                        trackedPlayerNamesString = playersToTrack.map(player => player.name).join('and ');
                    }                    
                    const werewolfWasFound = playersToTrack.find(player => player.role === 'werewolf');
                    abilityMessage.textContent = werewolfWasFound ? `A werewolf hides amongst ${trackedPlayerNamesString}` : `No werewolves amongst ${trackedPlayerNamesString}`;

                    // Activate special effects
                    this.specialEffects();
                },

                specialEffects() {
                    // Play the sound effect            
                    this.audio.play();

                    // Animation for main controls
                    const useAbilityButton = document.getElementById('useAbilityButton');
                    useAbilityButton.classList.add('fade-out');
                    useAbilityButton.addEventListener('transitionend', () => {
                        useAbilityButton.style.display = 'none';
                    }, { once: true });            

                    // Animation for tracker controls
                    if (this.role === "tracker") {
                        // Hide the track buttons after the ability is used
                        document.getElementById('trackLeftButton').classList.add('slide-right-fade-out');
                        document.getElementById('trackRightButton').classList.add('slide-left-fade-out');
                    }

                    // Animation for the background effect
                    const abilityEffect = document.getElementById('ability-effect');
                    abilityEffect.classList.add('growing');

                    // Animation for the special ability message
                    const abilityMessage = document.getElementById('abilityMessage');                    
                    abilityMessage.style.display = 'block';
                }
            }
        }
    </script>
</body>
</html>